#!/bin/bash

#SBATCH --job-name=yq_idr
#SBATCH --nodes=1
#SBATCH --mem=1G #it only took 43s for a pair of replicate to be run
#SBATCH --time=00:10:00
#SBATCH --output=/scratch/sclab/021420_ChIP/slurm_outputs/slurm_idr/idr_%j.out

# clear all module loaded in case of dependency conflicts
module purge

#load new modules required
module load idr/2.0.4

#### Usage of this script ####
# This script takes in peak files generated by macs2 of two chip replicates and assess the reproducibility.
# Input:
#   macs2 .NarrowPeak files from replicates
# Output:
#   bed file in NarrowPeak format with additional idr specific fields
#   png image showing the results of analyses
#   log file showing number of peaks passing the specified cutoff
#   

# move into ChIPseq analysis directory
basedir="/scratch/sclab/021420_ChIP"
cd $basedir
echo "here i am !! $PWD"
mkdir -p macs2peak

# idr analysis output folder name
idrdir="/scratch/sclab/021420_ChIP/idr/score/"

#### Main ####
for protein in wt e k r;
do
    array[0]=$protein
    peak1="${basedir}/macs2peak/${protein}1_macs2/${protein}1_macs2_peaks.narrowPeak"
    peak2="${basedir}/macs2peak/${protein}2_macs2/${protein}2_macs2_peaks.narrowPeak"
    echo "inputs peak files to idr"
    echo $peak1
    echo $peak2
    idr --samples $peak1 $peak2 --input-file-type narrowPeak \
    --rank signal.value --use-best-multisummit-IDR \
    --output-file ${idrdir}${protein}_idr \
    --plot \
    --log-output-file ${idrdir}${protein}.idr.log \
    && echo "${protein} idr run finished"
    # add .bed suffix to idr output peak file
    mv ${idrdir}${protein}_idr ${idrdir}${protein}_idr.bed
done

echo "ha! tihs is the end of the script!"

# clear all module loaded
module purge