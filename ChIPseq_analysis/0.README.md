# CRX ChIP-seq experiments in wild-type and mutant mouse retinas
This directory contains all scripts and metadata information used to process, analyze, and visualize CRX ChIP-seq data obtained from P14 wild-type and CRX HD mutant mouse retinas. The scripts should be run in the numbered order. Processed data needed to generate manuscript figures are stored under the `processed_data` folder. The raw data and additional processed data can be downloaded from [GEO](link_to_chipseq_GEO). 

## Brief description of the ChIP-seq analysis pipeline
All the analyses were performed on the WashU HTCF using SLURM.
1. **Assessing quality and adpater trimming:** `QC_trimgalore_ChIP.sbatch` performs adapter trimming by `trimgalore/0.6.1` on the raw FASTQ files and runs two quality control checks of the FASTQ files by `fastqc/0.11.7` before and after the trimming. The trimmed fq.gz files will be written to a new folder `./trim`. The output from FastQC will be written to the sub-directory `./trim/fastq_files`.
2. **Alignment to the genome and filtering:** `alignment_bowtie_ChIP.sbatch` aligns trimmed reads to the `mm10` genome by `bowtie2/2.3.5`; filters only uniquely mapped reads by `samtools/1.9` and `picard/2.21.4`; and removes alignments overlapped with blacklisted regions by `bedtools/2.27.1`. The final bam file is written to a new folder `./alignedbam`, sorted and indexed. A text file containing samtools flagstat statistics will be generated for output bam file and written to the sub-directory `./alignedbam/filtering_stats`. 
3. **Peak calling:** `peakcall_macs2_ChIP.sbatch` performs peak calling by `macs2/2.1.1.20160309` on the clean alignment files. The macs2 output files will be written to a new folder `./macs2peak` with each sample in their seperate sub-directory.
                     `replicate_idr_ChIP.sbatch` assesses concordance of peak calls between replicates using the [Irreproducibility Discovery Rate (IDR) framework](https://sites.google.com/site/anshulkundaje/projects/idr) (`idr/2.0.4`). The output files will be written to a new folder `./idr`.
4. **Visualization of peaks:** `bamtoBigWig_deeptools_ChIP.sbatch` converts alignement files (BAM) to bigWig files, generates coverage matrix, and makes coverage heatmaps using `deeptools/3.0.0`. This script also contains a function to calculate average coverage from two bigWig files. The output bigWig files will be written to a new folder `./bigwigs`. The coverage matrix and heatmaps will be written to another new folder `./deeptools`.
5. **Differential enrichement analysis:** `quantification_DiffBind_ChIP.sbatch` is a wrapper script to run the three R scripts.
   - `analyze_diffpeak.R` performs differential binding analysis with R Bioconductor package `DiffBind\3.0.15`. The post-analysis DBA object will be stored in RData format under folder `.\DiffBind\outputs`. A detailed description of the DiffBind pipeline can be found [here](https://hbctraining.github.io/Intro-to-ChIPseq/lessons/08_diffbind_differential_peaks.html). The normalized count matrix and differential analysis matrix were extracted from the DBA object, compiled, and written to `hdmuts_chip_compiled_matrix.tsv` under the `./processed_data` folder.
   - `extract_fasta.R` retrieves overlapping peaks for each CRX sample and fetches DNA sequences under each peak. The FASTA files will be written to the `./DiffBind/difffasta` folder. The mouse genome sequences were accessed through R Bioconductor package [BSgenome.Mmusculus.UCSC.mm10](https://bioconductor.org/packages/release/data/annotation/html/BSgenome.Mmusculus.UCSC.mm10.html). The overlap peakset for each CRX sample was extracted and written to `.tsv` files under the `./processed_data/olap_peakset` folder. `consensus_peakset.bed` contains the unique peak id to coordinates mapping for all CRX consensus peaks.
   - `GREAT_analysis.R` submits the CRX consensus peakset for [Genomic Regions Enrichment of Annotations Tool (GREAT) analysis](http://great.stanford.edu/public/html/splash.php) and retrieves results from the GREAT web server through R package [rGREAT\1.19.2](https://bioconductor.org/packages/release/bioc/vignettes/rGREAT/inst/doc/rGREAT.html). The GREAT analysis results were extracted and written to `hdmuts_chip_all_regions_great_gene.tsv` under the `./processed_data` folder.
6. **Genomic environment annotation:** `annotation_homer_ChIP.sbatch` annotates CRX peaks by `homer/4.8` annotatePeaks.pl function. The output bed file will be written to the same folder as the input bed file.
7. **_De novo_ motif discovery:**  `denovo_motif_searching_meme_ChIP.sbatch` performs motif analysis with the `meme/5.0.4` on FASTA files of different CRX peaksets. The output files will be written to a new folder `./MEME` with each sample in a separate sub-directory. The PWM matrices for enriched hoemeodomain motif in each genotype are compiled in `all_chip_pwm.meme` under the `./processed_data` folder.

## Metadata files
- `CRXHD_ChIP_lookup.txt` lists all input-ip pairs.
- `deeptools_bed_meta.csv` contains a list of bed files specifying genomic regions to calculate coverage and plot heatmaps.
- `CRXHD_DiffBind_meta.csv` is the experimental sample sheet used to construct the DBA object for differential binding analysis.
- `meme_meta.txt` lists the identifiers for FASTA files to be submitted to motif analysis.